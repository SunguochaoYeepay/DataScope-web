# DataScope 错误码规范

## 1. 错误码格式

错误码采用5位数字格式，具体规则如下：

- 第1位：错误级别
  - 1: 系统级错误
  - 2: 业务级错误
  - 3: 第三方服务错误
  - 4: 用户输入错误
  - 5: 权限相关错误

- 第2-3位：模块编号
  - 00: 系统通用
  - 01: 数据源管理
  - 02: 查询管理
  - 03: 元数据管理
  - 04: 用户管理
  - 05: 权限管理
  - 06: 配置管理
  - 07: AI功能
  - 08: 缓存管理
  - 09: 监控告警

- 第4-5位：具体错误编号（00-99）

## 2. 错误响应格式

```json
{
  "code": 20101,
  "message": "数据源连接失败",
  "details": {
    "cause": "Connection refused",
    "solution": "请检查数据源配置信息是否正确",
    "timestamp": "2024-03-20T10:00:00Z"
  }
}
```

## 3. 错误码列表

### 3.1 系统级错误 (1xxxx)
| 错误码 | 错误信息 | 错误描述 | 解决方案 |
|--------|----------|----------|----------|
| 10000 | 系统内部错误 | 未知的系统错误 | 请联系系统管理员 |
| 10001 | 服务暂时不可用 | 系统正在维护或过载 | 请稍后重试 |
| 10002 | 配置错误 | 系统配置有误 | 检查系统配置 |
| 10003 | 资源不足 | 系统资源不足 | 扩展系统资源或优化使用 |

### 3.2 数据源管理错误 (201xx)
| 错误码 | 错误信息 | 错误描述 | 解决方案 |
|--------|----------|----------|----------|
| 20100 | 数据源不存在 | 指定的数据源未找到 | 检查数据源ID是否正确 |
| 20101 | 数据源连接失败 | 无法建立数据源连接 | 检查数据源配置和网络 |
| 20102 | 数据源认证失败 | 数据源用户名或密码错误 | 验证认证信息 |
| 20103 | 数据源类型不支持 | 不支持的数据源类型 | 使用支持的数据源类型 |

### 3.3 查询管理错误 (202xx)
| 错误码 | 错误信息 | 错误描述 | 解决方案 |
|--------|----------|----------|----------|
| 20200 | 查询执行失败 | 执行查询时发生错误 | 检查查询语法和参数 |
| 20201 | 查询超时 | 查询执行时间超过限制 | 优化查询或增加超时时间 |
| 20202 | 查询语法错误 | SQL语法错误 | 修正查询语法 |
| 20203 | 查询结果过大 | 结果集超过大小限制 | 添加限制条件或分页 |

### 3.4 元数据管理错误 (203xx)
| 错误码 | 错误信息 | 错误描述 | 解决方案 |
|--------|----------|----------|----------|
| 20300 | 元数据获取失败 | 无法获取表结构信息 | 检查表权限和连接 |
| 20301 | 元数据更新失败 | 更新元数据缓存失败 | 检查缓存服务状态 |
| 20302 | 表不存在 | 指定的表未找到 | 检查表名是否正确 |
| 20303 | 字段不存在 | 指定的字段未找到 | 检查字段名是否正确 |

### 3.5 用户管理错误 (204xx)
| 错误码 | 错误信息 | 错误描述 | 解决方案 |
|--------|----------|----------|----------|
| 20400 | 用户不存在 | 指定的用户未找到 | 检查用户ID是否正确 |
| 20401 | 密码错误 | 用户密码验证失败 | 检查密码是否正确 |
| 20402 | 用户已禁用 | 用户账号已被禁用 | 联系管理员启用账号 |
| 20403 | 用户已存在 | 创建的用户已存在 | 使用其他用户名 |

### 3.6 权限管理错误 (205xx)
| 错误码 | 错误信息 | 错误描述 | 解决方案 |
|--------|----------|----------|----------|
| 20500 | 无访问权限 | 用户没有所需权限 | 申请所需权限 |
| 20501 | 令牌无效 | 访问令牌已过期或无效 | 重新登录获取令牌 |
| 20502 | 权限验证失败 | 权限验证过程失败 | 检查权限配置 |
| 20503 | 越权操作 | 尝试执行超出权限的操作 | 使用适当的权限级别 |

### 3.7 AI功能错误 (207xx)
| 错误码 | 错误信息 | 错误描述 | 解决方案 |
|--------|----------|----------|----------|
| 20700 | AI服务不可用 | AI服务暂时不可用 | 检查AI服务状态 |
| 20701 | 模型调用失败 | AI模型调用出错 | 检查请求参数和限制 |
| 20702 | 结果解析失败 | 无法解析AI返回结果 | 检查输入格式是否正确 |
| 20703 | 额度不足 | AI服务使用额度不足 | 升级服务计划 |

### 3.8 缓存管理错误 (208xx)
| 错误码 | 错误信息 | 错误描述 | 解决方案 |
|--------|----------|----------|----------|
| 20800 | 缓存服务异常 | 缓存服务不可用 | 检查缓存服务状态 |
| 20801 | 缓存写入失败 | 无法写入缓存数据 | 检查缓存容量和配置 |
| 20802 | 缓存读取失败 | 无法读取缓存数据 | 检查缓存键值是否正确 |
| 20803 | 缓存已满 | 缓存空间不足 | 清理或扩展缓存空间 |

## 4. 错误处理最佳实践

### 4.1 错误日志记录
```java
try {
    // 业务逻辑
} catch (DataSourceException e) {
    log.error("数据源操作失败: {}", e.getMessage(), e);
    throw new BusinessException(20101, "数据源连接失败", e);
} catch (Exception e) {
    log.error("系统异常: {}", e.getMessage(), e);
    throw new SystemException(10000, "系统内部错误", e);
}
```

### 4.2 错误响应处理
```java
@ExceptionHandler(BusinessException.class)
public ResponseEntity<ErrorResponse> handleBusinessException(BusinessException e) {
    ErrorResponse error = new ErrorResponse(
        e.getCode(),
        e.getMessage(),
        new ErrorDetails(e.getCause(), e.getSolution(), LocalDateTime.now())
    );
    return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(error);
}
```

### 4.3 错误码使用规范
1. 保持错误码的唯一性
2. 错误信息要清晰明确
3. 提供有效的解决方案
4. 记录详细的错误日志
5. 定期review错误码使用情况
6. 及时更新错误码文档

## 5. 错误码管理工具

### 5.1 错误码生成
```java
public class ErrorCodeGenerator {
    public static String generateErrorCode(int level, int module, int specific) {
        return String.format("%d%02d%02d", level, module, specific);
    }
}
```

### 5.2 错误码验证
```java
public class ErrorCodeValidator {
    public static boolean isValidErrorCode(String code) {
        return code.matches("^[1-5][0-9]{4}$");
    }
}
```